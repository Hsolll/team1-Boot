<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.omb.user.product.dao.ProductDao">



	<sql id="productSearch">
		<if test="search=='all'">
			<![CDATA[ p_title LIKE '%'|| #{keyword}||'%']]>OR<![CDATA[ p_content LIKE '%'|| #{keyword}||'%']]>
		</if>
		<if test="search=='p_title'">
			<![CDATA[ p_title LIKE '%'|| #{keyword}||'%']]>
		</if>
		<if test="search=='p_content'">
			<![CDATA[ p_content LIKE '%'|| #{keyword}||'%']]>
		</if>
	</sql>

	<select id="selectProductList" resultType="product">
  		<![CDATA[ 
 		SELECT  
         		P_NO, U_NO, P_TITLE, P_NAME, P_PRICE, P_STATUS, P_CONTENT, P_LOCAL, TRANS_METHOD, P_CREATED_AT, P_UPDATED_AT, P_DELETED_AT, p_file, p_thumb, P_CATE, P_ADM_PER 
 		FROM ( 
 		        SELECT /*+ INDEX_DESC(TB_USER_PRODUCT TB_USER_PRODUCT_PK) */ 
 		            rownum as rnum, p.P_NO,u.U_NO,p.P_TITLE,p.P_NAME,p.P_PRICE,p.P_STATUS,p.P_CONTENT,p.P_LOCAL,p.TRANS_METHOD,p.P_CREATED_AT,p.P_UPDATED_AT,p.P_DELETED_AT,p.p_file,p.p_thumb,p.P_CATE,p.P_ADM_PER 
 		        FROM  
 		            TB_USER_PRODUCT p INNER JOIN TB_USER u ON p.U_NO = u.U_NO  
 		        WHERE]]> 
            	<trim prefix="(" suffix=") AND " prefixOverrides="AND">
            		<include refid="productSearch"></include>
            	</trim> 
            <![CDATA[rownum <= #{pageNum} * #{amount}
 		     ) PRODUCTLIST 
		WHERE  
		    rnum > (#{pageNum} - 1) * #{amount} AND P_ADM_PER = 1 
    	]]>
	</select>
	
	<select id="selectProductDetail" parameterType="int" resultType="product">
		
		SELECT
		    p.P_NO,u.U_NO,u.U_NICK,p.P_TITLE,p.P_NAME,p.P_PRICE,p.P_STATUS,p.P_CONTENT,p.P_LOCAL,p.TRANS_METHOD,p.P_CREATED_AT,p.P_UPDATED_AT,p.P_DELETED_AT,p.p_file,p.p_thumb,p.P_CATE,p.p_adm_per
		FROM
		    TB_USER_PRODUCT p 
		    	INNER JOIN 
		    		TB_USER u ON p.U_NO = u.U_NO
		WHERE
			p.P_NO = #{p_no}
			
	</select>
	
	<insert id="insertProduct" parameterType="product">
	    <selectKey keyProperty="p_no" resultType="int" order="BEFORE">
	        SELECT TB_USER_PRODUCT_SEQ.NEXTVAL FROM DUAL
	    </selectKey>
	    
	    INSERT INTO TB_USER_PRODUCT
	        (P_NO,U_NO,P_TITLE,P_NAME,P_PRICE,P_STATUS,P_CONTENT,P_LOCAL,TRANS_METHOD,p_thumb,p_file,P_CATE,p_adm_per)
	    VALUES
	        (#{p_no},#{u_no},#{p_title},#{p_name},#{p_price},#{p_status},#{p_content},#{p_local},#{trans_method},#{p_thumb},#{p_file},#{p_cate},#{p_adm_per})
	</insert>
	
	<insert id="insertProductLike" parameterType="product">
	    INSERT INTO TB_USER_PRODUCT_LIKE
	        (PROD_NO,P_NO,U_NO,PROD_LIKE)
	    VALUES
	        (TB_USER_PRODUCT_LIKE_SEQ.NEXTVAL,#{p_no},#{u_no},#{prod_like})
	</insert>
	
	<delete id="deleteProductLike" parameterType="product">
	    DELETE 
	    	TB_USER_PRODUCT_LIKE
	    WHERE
	    	P_NO = #{p_no} and U_NO = #{u_no}
	
	</delete>
	
	<select id="productListCnt" parameterType="product" resultType="int">
		SELECT 
		    count(*) 
		FROM 
		    TB_USER_PRODUCT
		WHERE 
		    P_ADM_PER = 1
		
	</select>
	
	<!-- 마이페이지 카운트 -->
	<select id="productMyPageListCnt" parameterType="product" resultType="int">
		SELECT 
		    count(*) 
		FROM 
		    TB_USER_PRODUCT
		WHERE 
		    u_no=#{u_no}
		
	</select>
	
	
	
	<select id="productCateListCnt" parameterType="product" resultType="int">
		SELECT 
		    count(*) 
		FROM 
		    TB_USER_PRODUCT
		WHERE 
		    p_cate = #{p_cate} AND P_ADM_PER = 1
	</select>
	
	<select id="category" parameterType="product" resultType="product">
		<![CDATA[ 
		SELECT 
		        rnum,P_NO,U_NO,P_TITLE,P_NAME,P_PRICE,P_STATUS,P_CONTENT,P_LOCAL,TRANS_METHOD,P_CREATED_AT,
		        P_UPDATED_AT,P_DELETED_AT ,p_file,p_thumb,P_CATE,p_adm_per
		FROM (
		        SELECT /*+ INDEX_DESC(TB_USER_PRODUCT TB_USER_PRODUCT_PK) */ 
		            rownum as rnum, p.P_NO,u.U_NO,p.P_TITLE,p.P_NAME,p.P_PRICE,p.P_STATUS,
		            p.P_CONTENT,p.P_LOCAL,p.TRANS_METHOD,p.P_CREATED_AT,
		            p.P_UPDATED_AT,p.P_DELETED_AT ,p.p_file,p.p_thumb,p.P_CATE,p.p_adm_per
		        FROM    
		            TB_USER_PRODUCT p INNER JOIN TB_USER u ON p.U_NO = u.U_NO 
		        WHERE 
		            rownum <= #{pageNum} * #{amount} AND P_CATE=#{p_cate}
		     ) PRODUCTLIST
		WHERE 
		    rnum > (#{pageNum} - 1) * #{amount} AND P_ADM_PER = 1 AND P_CATE = #{p_cate}
]]>
	</select>
	
	<select id="selectLocal" parameterType="product" resultType="product">
		<![CDATA[ 
		SELECT 
        		P_NO, U_NO, P_TITLE, P_NAME, P_PRICE, P_STATUS, P_CONTENT, P_LOCAL, TRANS_METHOD, P_CREATED_AT, P_UPDATED_AT, P_DELETED_AT, p_file, p_thumb, P_CATE, P_ADM_PER
		FROM (
		        SELECT /*+ INDEX_DESC(TB_USER_PRODUCT TB_USER_PRODUCT_PK) */ 
		            rownum as rnum, p.P_NO,u.U_NO,p.P_TITLE,p.P_NAME,p.P_PRICE,p.P_STATUS,p.P_CONTENT,p.P_LOCAL,p.TRANS_METHOD,p.P_CREATED_AT,p.P_UPDATED_AT,p.P_DELETED_AT,p.p_file,p.p_thumb,p.P_CATE,p.P_ADM_PER
		        FROM 
		            TB_USER_PRODUCT p INNER JOIN TB_USER u ON p.U_NO = u.U_NO 
		        WHERE 
		            rownum <= #{pageNum} * #{amount} AND p.P_LOCAL = #{p_local}
		     ) PRODUCTLIST
		WHERE 
		    rnum > (#{pageNum} - 1) * #{amount} AND P_ADM_PER = 1 AND P_LOCAL = #{p_local}
    	]]>
	
	</select>
	
	<select id="productLocalListCnt" parameterType="product" resultType="int">
		SELECT    
		    count(*) 
		FROM 
		    TB_USER_PRODUCT
		WHERE 
		    p_local = #{p_local} AND P_ADM_PER = 1
	</select>
	
	<select id="myWrite" parameterType="product" resultType="product">
		<![CDATA[ 
		SELECT 
        		P_NO, U_NO, P_TITLE, P_NAME, P_PRICE, P_STATUS, P_CONTENT, P_LOCAL, TRANS_METHOD, P_CREATED_AT, P_UPDATED_AT, P_DELETED_AT, p_file, p_thumb, P_CATE, P_ADM_PER
		FROM (
		        SELECT /*+ INDEX_DESC(TB_USER_PRODUCT TB_USER_PRODUCT_PK) */ 
		            rownum as rnum, p.P_NO,u.U_NO,p.P_TITLE,p.P_NAME,p.P_PRICE,p.P_STATUS,p.P_CONTENT,p.P_LOCAL,p.TRANS_METHOD,p.P_CREATED_AT,p.P_UPDATED_AT,p.P_DELETED_AT,p.p_file,p.p_thumb,p.P_CATE,p.P_ADM_PER
		        FROM 
		            TB_USER_PRODUCT p INNER JOIN TB_USER u ON p.U_NO = u.U_NO 
		        WHERE 
		            rownum <= #{pageNum} * #{amount} AND u.U_NO = #{u_no}
		     ) PRODUCTLIST
		WHERE 
		    rnum > (#{pageNum} - 1) * #{amount} AND U_NO = #{u_no}
    	]]>
		
	</select>
	
	<select id="WriteListCnt" parameterType="product" resultType="int">
		SELECT 
		    count(*) 
		FROM 
		    TB_USER_PRODUCT
		WHERE 
		    U_NO = #{u_no}
	</select>
	
	<select id="updateForm" parameterType="product" resultType="product">
		SELECT 
		    * 
		FROM 
		    TB_USER_PRODUCT
		WHERE 
		    U_NO = #{u_no} AND P_NO =#{p_no}
		
	</select>
	
	<update id="update" parameterType="product">
		UPDATE TB_USER_PRODUCT
		SET
			P_TITLE =#{p_title},
			P_NAME =#{p_name},
			P_PRICE =#{p_price},
			P_STATUS =#{p_status},
			P_CONTENT =#{p_content},
			P_LOCAL =#{p_local},
			TRANS_METHOD =#{trans_method},
			p_thumb =#{p_thumb},
			p_file =#{p_file},
			P_CATE =#{p_cate}
		WHERE
			U_NO =#{u_no} AND P_NO = #{p_no}
	    AND EXISTS (
	        SELECT 1
	        FROM TB_USER_PRODUCT
	        WHERE U_NO = #{u_no} AND P_NO = #{p_no}
	        HAVING COUNT(*) = 1
	    )
	</update>


	<delete id="delete" parameterType="product">
		DELETE 
		FROM 
			TB_USER_PRODUCT
		WHERE 
			P_NO = #{p_no} AND U_NO = #{u_no} 
	</delete>
	
	<select id="sel" parameterType="product" resultType="product">
		SELECT
		    p.P_NO,u.U_NO,p.P_TITLE,p.P_NAME,p.P_PRICE,p.P_STATUS,p.P_CONTENT,p.P_LOCAL,p.TRANS_METHOD,p.P_CREATED_AT,p.P_UPDATED_AT,p.P_DELETED_AT,p.p_file,p.p_thumb,p.P_CATE,p.p_adm_per
		FROM
		    TB_USER_PRODUCT p 
		    	INNER JOIN 
		    		TB_USER u ON p.U_NO = u.U_NO
		WHERE
			p.P_NO = #{p_no} AND u.U_NO = #{u_no}
	</select>

	<select id="selectQueuedList" resultType="product" parameterType="product">
  		<![CDATA[ 
		SELECT 
        		P_NO, U_NO, P_TITLE, P_NAME, P_PRICE, P_CONTENT, P_CREATED_AT, 
        		P_UPDATED_AT, P_DELETED_AT, P_FILE, P_THUMB, P_CATE, P_ADM_PER
		FROM (
		        SELECT  
		            rownum as rnum, p.P_NO, u.U_NO, p.P_TITLE, p.P_NAME, p.P_PRICE,
		            p.P_CONTENT, p.P_LOCAL, p.TRANS_METHOD, p.P_CREATED_AT,
		            p.P_UPDATED_AT, p.P_DELETED_AT, p.p_file, p.p_thumb, p.P_CATE, p.P_ADM_PER
		        FROM 
		            TB_USER_PRODUCT p INNER JOIN TB_USER u ON p.U_NO = u.U_NO 
		        WHERE 
		            rownum <= #{pageNum} * #{amount}
		     ) PRODUCTLIST
		WHERE 
		    rnum > (#{pageNum} - 1) * #{amount} AND P_ADM_PER = 0
    	]]>
	</select>
	
	<update id="updateAdmRecognize" parameterType="product">
		UPDATE TB_USER_PRODUCT
		SET P_ADM_PER = 1
		WHERE P_NO = #{p_no}
	</update>
	
	<update id="updateAdmReject" parameterType="product">
		UPDATE TB_USER_PRODUCT
		SET P_ADM_PER = 2
		WHERE P_NO = #{p_no}
	</update>
	
	<select id="selectRejectedList" resultType="product" parameterType="product">
  		<![CDATA[ 
		SELECT 
        		P_NO, U_NO, P_TITLE, P_NAME, P_PRICE, P_CONTENT, P_CREATED_AT, 
        		P_UPDATED_AT, P_DELETED_AT, P_FILE, P_THUMB, P_CATE, P_ADM_PER
		FROM (
		        SELECT  
		            rownum as rnum, p.P_NO, u.U_NO, p.P_TITLE, p.P_NAME, p.P_PRICE,
		            p.P_CONTENT, p.P_LOCAL, p.TRANS_METHOD, p.P_CREATED_AT,
		            p.P_UPDATED_AT, p.P_DELETED_AT, p.p_file, p.p_thumb, p.P_CATE, p.P_ADM_PER
		        FROM 
		            TB_USER_PRODUCT p INNER JOIN TB_USER u ON p.U_NO = u.U_NO 
		        WHERE 
		            rownum <= #{pageNum} * #{amount}
		     ) PRODUCTLIST
		WHERE 
		    rnum > (#{pageNum} - 1) * #{amount} AND P_ADM_PER = 2
    	]]>
	</select>
	
	<!-- 마이페이지 판매내역 조회 -->
	<select id="selectProductSellList" parameterType="member" resultType="product">
  		<![CDATA[ 
		SELECT 
        		rownum,P_NO, u_no, P_TITLE, P_NAME, P_PRICE, P_STATUS, P_CONTENT, P_LOCAL, TRANS_METHOD, P_CREATED_AT, P_UPDATED_AT, P_DELETED_AT, p_file, p_thumb, P_CATE, P_ADM_PER , p_buyid
		FROM (
		        SELECT /*+ INDEX_DESC(TB_USER_PRODUCT TB_USER_PRODUCT_PK) */ 
		             p.P_NO,u.u_no,p.P_TITLE,p.P_NAME,p.P_PRICE,p.P_STATUS,p.P_CONTENT,p.P_LOCAL,p.TRANS_METHOD,p.P_CREATED_AT,p.P_UPDATED_AT,p.P_DELETED_AT,p.p_file,p.p_thumb,p.P_CATE,p.P_ADM_PER, p.p_buyid
		        FROM 
		            TB_USER_PRODUCT p INNER JOIN TB_USER u ON p.U_NO = u.U_NO 
		        WHERE 
		            u.u_no=#{u_no}  AND P_ADM_PER = 1 
		            order by p_no desc
		     ) PRODUCTLIST
		WHERE 
		    rownum <= #{pageNum} * #{amount}
		    
    	]]>
    	</select>


	<!-- 마이페이지 구매내역 조회 -->
	<select id="selectProductBuyList" parameterType="member" resultType="product">
  		<![CDATA[ 
		SELECT 
        		rownum,P_NO, u_no, P_TITLE, P_NAME, P_PRICE, P_STATUS, P_CONTENT, P_LOCAL, TRANS_METHOD, P_CREATED_AT, P_UPDATED_AT, P_DELETED_AT, p_file, p_thumb, P_CATE, P_ADM_PER , p_buyid
		FROM (
		        SELECT /*+ INDEX_DESC(TB_USER_PRODUCT TB_USER_PRODUCT_PK) */ 
		             p.P_NO,u.u_no,p.P_TITLE,p.P_NAME,p.P_PRICE,p.P_STATUS,p.P_CONTENT,p.P_LOCAL,p.TRANS_METHOD,p.P_CREATED_AT,p.P_UPDATED_AT,p.P_DELETED_AT,p.p_file,p.p_thumb,p.P_CATE,p.P_ADM_PER, p.p_buyid
		        FROM 
		            TB_USER_PRODUCT p INNER JOIN TB_USER u ON p.U_NO = u.U_NO 
		        WHERE 
		            p.p_buyid=#{u_id}  AND P_ADM_PER = 1 
		            order by p_no desc
		     ) PRODUCTLIST
		WHERE 
		    rownum <= #{pageNum} * #{amount}
		    
    	]]>
    	</select>
    	
    	<!-- 마이페이지 좋아요(찜)내역 조회 -->
	<select id="selectProductLikeList" parameterType="member" resultType="product">
  		<![CDATA[ 
		SELECT 
        		rownum,P_NO, u_no, P_TITLE, P_NAME, P_PRICE, P_STATUS, P_CONTENT, P_LOCAL, TRANS_METHOD, P_CREATED_AT, P_UPDATED_AT, P_DELETED_AT, p_file, p_thumb, P_CATE, P_ADM_PER , p_buyid ,prod_no,prod_like
		FROM (
		        SELECT /*+ INDEX_DESC(TB_USER_PRODUCT TB_USER_PRODUCT_PK) */ 
		             p.P_NO,u.u_no,p.P_TITLE,p.P_NAME,p.P_PRICE,p.P_STATUS,p.P_CONTENT,p.P_LOCAL,p.TRANS_METHOD,p.P_CREATED_AT,p.P_UPDATED_AT,p.P_DELETED_AT,p.p_file,p.p_thumb,p.P_CATE,p.P_ADM_PER, p.p_buyid ,prod_no,prod_like
		        FROM 
		            TB_USER_PRODUCT p INNER JOIN TB_USER u ON p.U_NO = u.U_NO inner join tb_user_product_like l on p.u_no = l.u_no
		        WHERE 
		            u.u_no=#{u_no}  AND P_ADM_PER = 1 and prod_like=1 
		            order by p_no desc
		     ) PRODUCTLIST
		WHERE 
		    rownum <= #{pageNum} * #{amount}
		    
    	]]>
    	</select>
    	<!-- 마이페이지 판매확정  -->
    	<update id="productStatus" parameterType="product">
    	update tb_user_product
    	set p_status = #{p_status} , p_buyid= #{p_buyid}
    	where p_no =#{p_no}
    	</update>
</mapper>