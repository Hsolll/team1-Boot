<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.omb.user.orderInfo.dao.OrderInfoDAO">

	<!-- 주문내역 추가 쿼리문 -->
	<insert id="insertOrderInfo" parameterType="orderinfo">
		INSERT INTO TB_USER_ORDER (O_NO, O_ID, PAY_NO, U_NO, SP_NO, RECEIVER, REC_TEL, O_ADDRESS)
		VALUES (TB_USER_ORDER_SEQ.NEXTVAL, #{o_id}, #{pay_no}, #{u_no}, #{sp_no}, #{receiver}, ${receiver_tel}, #{o_address})
	</insert>
	
	<!-- 구매목록 조회 쿼리문 -->
	<select id="buyOrderInfoList" parameterType="member" resultType="orderinfo">
		SELECT 
		    O_NO, O_ID, PAY_NO, 
		    (SELECT PAY_ID FROM TB_USER_PAYMENT WHERE PAY_NO = A.PAY_NO) AS PAY_ID,
		    A.U_NO, U_ID AS BUYER, A.SP_NO, SP_NAME, SP_PRICE,
		    (SELECT U_ID FROM TB_USER WHERE U_NO = C.U_NO) AS SELLER,
		    C.U_NO AS SELLER_NO, O_ADDRESS,
		    TO_CHAR(O_DATE, 'YYYY-MM-DD') AS O_DATE, O_STATUS
		FROM TB_USER_ORDER A
		INNER JOIN TB_USER B
		    ON A.U_NO = B.U_NO
		INNER JOIN TB_USER_SAFE_PRODUCT C
		    ON A.SP_NO = C.SP_NO
		WHERE A.U_NO = #{u_no}
		ORDER BY O_NO DESC
	</select>
	
	
	<!-- 판매목록 조회 쿼리문 -->
	<select id="sellOrderInfoList" parameterType="member" resultType="orderinfo">
		SELECT 
		    O_NO, O_ID, PAY_NO, A.U_NO, U_ID AS BUYER, A.SP_NO, SP_NAME, SP_PRICE,
		    (SELECT U_ID FROM TB_USER WHERE U_NO = C.U_NO) AS SELLER,
		    C.U_NO, O_ADDRESS,
		    TO_CHAR(O_DATE, 'YYYY-MM-DD') AS O_DATE, O_STATUS
		FROM TB_USER_ORDER A
		INNER JOIN TB_USER B
		    ON A.U_NO = B.U_NO
		INNER JOIN TB_USER_SAFE_PRODUCT C
		    ON A.SP_NO = C.SP_NO
		WHERE C.U_NO = #{u_no}
		ORDER BY O_NO DESC
	</select>
	
	
	<select id="selectPaymentId" parameterType="orderinfo" resultType="payment">
		SELECT 
		    PAY_ID
		FROM TB_USER_PAYMENT A
		INNER JOIN TB_USER_ORDER B
		    ON A.PAY_NO = B.PAY_NO
		WHERE O_NO = #{o_no}
	</select>
	
	
	<update id="updateOrderStatusCancel" parameterType="orderinfo">
		UPDATE TB_USER_ORDER SET O_STATUS = '결제취소' WHERE O_NO = #{o_no}
	</update>
	
	<update id="updateOrderStatusConfirm" parameterType="orderinfo">
		UPDATE TB_USER_ORDER SET O_STATUS = '거래완료' WHERE O_NO = #{o_no}
	</update>
	
	<select id="selectOrderInfoPrice" parameterType="orderInfo" resultType="orderInfo">
		SELECT 
		    PRICE AS SP_PRICE
		FROM TB_USER_PAYMENT A
		INNER JOIN TB_USER_ORDER B
		    ON A.PAY_NO = B.PAY_NO
		WHERE O_NO = #{o_no}
	</select>
	
	<update id="updateOrderStatusSend" parameterType="orderInfo">
		UPDATE TB_USER_ORDER SET O_STATUS = '배송중' WHERE O_NO = #{o_no}
	</update>
	
	
	<!-- 거래완료 시 상품 판매상태 변경 -->
	<!-- 안심상품 -->
	<update id="updateCompleteSafe" parameterType="orderInfo">
		UPDATE TB_USER_SAFE_PRODUCT
		SET SP_STATUS = '판매중'
		WHERE SP_NO = (SELECT SP_NO FROM TB_USER_ORDER WHERE O_NO = #{o_no})
	</update>
	
	<!-- 중고상품 -->
	<update id="updateCompleteProduct" parameterType="orderInfo">
		UPDATE TB_USER_PRODUCT
		SET P_STATUS = '판매완료'
		WHERE P_NO = (SELECT P_NO
		            FROM TB_USER_SAFE_PRODUCT
		            WHERE SP_NO = (SELECT SP_NO FROM TB_USER_ORDER WHERE O_NO = #{o_no}))
	</update>
	
	
</mapper>